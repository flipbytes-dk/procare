# Story 1.1: Project Foundation & Infrastructure Setup

## Status
Draft

## Story

**As a** developer,
**I want** to properly configure the existing GitHub repository with Turborepo monorepo structure, CI/CD, and development environment optimized for Hetzner VPS deployment via Coolify with Nixpacks,
**so that** the team can collaborate effectively and deploy code reliably to our self-hosted infrastructure.

## Acceptance Criteria

1. Existing GitHub repository configured with appropriate .gitignore for Node.js/TypeScript and environment files
2. CI/CD pipeline configured (GitHub Actions) with automated testing, linting, and build steps optimized for Coolify deployment
3. Turborepo monorepo structure established with directories for: services (agents), frontend (web dashboard), shared libraries, and agent services
4. Development environment configured to connect to VPS-hosted services (PostgreSQL, Redis, RabbitMQ, MinIO)
5. Environment variable management system (.env files, secrets management) for both local and production environments
6. Basic health check endpoint or canary page to verify deployment
7. README with setup instructions, architecture overview, development workflow, and Coolify deployment guide
8. Code formatting and linting rules configured (ESLint/Prettier for TypeScript)
9. Nixpacks configuration files prepared for Coolify deployment of all applications

## Tasks / Subtasks

- [ ] Configure existing GitHub repository and create .gitignore (AC: 1)
  - [ ] Create comprehensive .gitignore covering Node.js, TypeScript, environment files, and IDE files
  - [ ] Verify repository origin and remote configuration
- [ ] Set up Turborepo monorepo structure (AC: 3)
  - [ ] Create root package.json with workspace configuration
  - [ ] Set up pnpm-workspace.yaml
  - [ ] Configure turbo.json for build optimization
  - [ ] Create directory structure: apps/, packages/, .github/
- [ ] Configure shared packages (AC: 3)
  - [ ] Create database package with Prisma schema
  - [ ] Create shared package with types and utilities
  - [ ] Create ui package with ShadCN components
  - [ ] Create ui-native package with React Native components
- [ ] Set up applications structure (AC: 3)
  - [ ] Create mobile app structure (React Native + Expo)
  - [ ] Create api-gateway structure (Express.js + tRPC)
  - [ ] Create doctor-dashboard structure (Next.js)
  - [ ] Create caregiver-dashboard structure (Next.js)
  - [ ] Create agent-services structure for 7 microservices
- [ ] Configure TypeScript and ESLint (AC: 8)
  - [ ] Set up root tsconfig.json with strict mode
  - [ ] Configure ESLint with TypeScript, React, and React Native rules
  - [ ] Set up Prettier configuration
  - [ ] Create shared ESLint configurations in packages/config/
- [ ] Configure VPS services connection (AC: 4)
  - [ ] Document VPS service setup (PostgreSQL, Redis, RabbitMQ, MinIO)
  - [ ] Configure environment variables for VPS service connections
  - [ ] Create health check scripts for VPS services
  - [ ] Document local development workflow using VPS services
- [ ] Set up environment variable management (AC: 5)
  - [ ] Create .env.example with all required variables
  - [ ] Configure environment variables for each app
  - [ ] Document environment variable requirements
- [ ] Create CI/CD pipeline with GitHub Actions for Coolify deployment (AC: 2)
  - [ ] Set up continuous integration workflow (.github/workflows/ci.yml)
  - [ ] Configure automated testing (unit, integration)
  - [ ] Configure automated linting and type checking
  - [ ] Set up build verification optimized for Coolify
  - [ ] Create deployment workflow triggers for Coolify auto-deployment
- [ ] Implement health check endpoints (AC: 6)
  - [ ] Create /health endpoint in API Gateway
  - [ ] Create health checks for all agent services
  - [ ] Set up health check dashboard
- [ ] Create comprehensive README with Coolify deployment guide (AC: 7)
  - [ ] Write project overview and architecture summary
  - [ ] Document development setup instructions
  - [ ] Add Coolify deployment guide for Hetzner VPS
  - [ ] Include contributing guidelines
- [ ] Configure Nixpacks for Coolify deployment (AC: 9)
  - [ ] Create nixpacks.toml files for each application
  - [ ] Configure build commands for mobile app (Expo), web dashboards (Next.js), and backend services
  - [ ] Set up start commands optimized for production
  - [ ] Document Nixpacks configuration for Coolify
- [ ] Set up testing framework configuration (AC: 2, 8)
  - [ ] Configure Vitest for unit testing
  - [ ] Set up test database configuration
  - [ ] Create test setup files for different environments
  - [ ] Configure coverage reporting

## Dev Notes

### Project Structure Information
**Source: architecture/12-unified-project-structure.md**

The complete Turborepo monorepo structure must be established as follows:

```
procare/
├── apps/
│   ├── mobile/                      # React Native mobile app (Expo)
│   ├── doctor-dashboard/            # Next.js doctor dashboard
│   ├── caregiver-dashboard/         # Next.js caregiver dashboard
│   ├── api-gateway/                 # Express.js + tRPC API Gateway
│   └── agent-services/              # 7 AI microservices
│       ├── engagement-engine/
│       ├── clinical-monitor/
│       ├── health-insights/
│       ├── lifestyle-coach/
│       ├── pooled-questions/
│       ├── trial-manager/
│       └── revenue-optimizer/
├── packages/
│   ├── database/                    # Prisma ORM
│   ├── shared/                      # Shared utilities & types
│   ├── ui/                          # Web UI components (ShadCN)
│   ├── ui-native/                   # React Native UI components
│   ├── openrouter-client/           # OpenRouter API client
│   ├── whatsapp-client/             # Evolution API client
│   └── config/                      # Shared configurations
```

### Technology Stack Requirements
**Source: architecture/tech-stack.md**

Key technology versions that must be configured:
- **Node.js**: 20 LTS
- **TypeScript**: 5.3+ with strict mode enabled
- **Package Manager**: pnpm 9.15.0
- **Monorepo**: Turborepo 2.x
- **Mobile**: React Native + Expo 51+
- **Web**: Next.js 14.x (App Router)
- **Backend**: Express.js 4.x + tRPC 10.x
- **Database**: PostgreSQL 16.x + Prisma 5.x
- **Cache**: Redis 7.x
- **Queue**: RabbitMQ 3.13+
- **Testing**: Vitest + Testing Library
- **Linting**: ESLint + Prettier

### Root Configuration Files
**Source: architecture/12-unified-project-structure.md**

**package.json** must include:
```json
{
  "name": "procare",
  "version": "1.0.0",
  "private": true,
  "workspaces": [
    "apps/*",
    "apps/agent-services/*",
    "packages/*"
  ],
  "scripts": {
    "dev": "turbo run dev",
    "build": "turbo run build",
    "test": "turbo run test",
    "lint": "turbo run lint",
    "format": "prettier --write \"**/*.{ts,tsx,md}\"",
    "db:migrate": "pnpm --filter=database prisma migrate deploy",
    "db:generate": "pnpm --filter=database prisma generate",
    "db:seed": "pnpm --filter=database prisma db seed",
    "db:reset": "pnpm --filter=database prisma migrate reset",
    "services:status": "node scripts/check-vps-services.js",
    "services:setup": "node scripts/setup-vps-services.js",
    "clean": "turbo run clean && rm -rf node_modules"
  },
  "packageManager": "pnpm@9.15.0",
  "engines": {
    "node": ">=20.0.0"
  }
}
```

**turbo.json** configuration:
```json
{
  "$schema": "https://turbo.build/schema.json",
  "globalDependencies": ["**/.env.*local"],
  "pipeline": {
    "build": {
      "dependsOn": ["^build"],
      "outputs": [".next/**", "!.next/cache/**", "dist/**"]
    },
    "dev": {
      "cache": false,
      "persistent": true
    },
    "test": {
      "dependsOn": ["^build"],
      "outputs": ["coverage/**"]
    },
    "lint": {
      "dependsOn": ["^build"]
    }
  }
}
```

### Deployment Architecture Requirements
**Source: architecture/14-deployment-architecture.md**

ProCare uses self-hosted infrastructure on **Hetzner Cloud VPS** with **Coolify** as deployment platform:
- **Hosting**: Hetzner Cloud VPS (CPX41 for production, CPX21 for staging)
- **Deployment Platform**: Coolify v4.x with Git-based deployment
- **Build System**: Nixpacks (instead of Docker) for application builds
- **SSL**: Automatic SSL certificates via Coolify
- **Monitoring**: Coolify built-in monitoring

### VPS Services Configuration
**Source: architecture/tech-stack.md + deployment requirements**

All services will be hosted directly on Hetzner VPS and used for both local development and production:
- **PostgreSQL**: Primary database with TimescaleDB extension (VPS-hosted)
- **Redis**: Caching and session storage (VPS-hosted)
- **RabbitMQ**: Message queue for agent communication (VPS-hosted)
- **MinIO**: S3-compatible object storage (VPS-hosted)

**Connection Security**: All connections to VPS services should use secure connections (SSL/TLS) and appropriate authentication mechanisms.

### Nixpacks Configuration Requirements
For Coolify deployment, each application needs a `nixpacks.toml` file:
- **Mobile App**: Expo build configuration
- **API Gateway**: Node.js Express server
- **Doctor/Caregiver Dashboards**: Next.js static builds
- **Agent Services**: Node.js microservices with health checks

### Environment Variables Template
**Source: architecture/12-unified-project-structure.md**

The .env.example must include all required environment variables for:
- Database connections (PostgreSQL on VPS)
- Cache configuration (Redis on VPS)
- Message queue (RabbitMQ on VPS)
- Storage (MinIO on VPS)
- Authentication (JWT secrets)
- External APIs (OpenRouter, Evolution API, Razorpay)
- CDN (BunnyCDN)
- VPS service endpoints and credentials

### TypeScript Configuration
**Source: architecture/17-coding-standards.md**

TypeScript must be configured with strict mode:
```json
{
  "compilerOptions": {
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noImplicitReturns": true,
    "noFallthroughCasesInSwitch": true,
    "forceConsistentCasingInFileNames": true
  }
}
```

### Git Workflow Standards
**Source: architecture/17-coding-standards.md**

Configure conventional commits:
```
<type>(<scope>): <subject>

Examples:
feat(glucose): add voice input for glucose logging
fix(clinical-monitor): resolve race condition in emergency detection
refactor(api-gateway): extract rate limiting logic to middleware
docs(architecture): add security section
test(glucose-router): add integration tests for emergency flow
chore(deps): upgrade Prisma to v5.8.0
```

### Project Structure Notes
The existing GitHub repository contains basic documentation and some initial structure. The complete foundation infrastructure must be established within this existing repository according to the architecture specifications. This includes:
- Setting up Turborepo monorepo structure in the existing repo
- Configuring Nixpacks for Coolify deployment (instead of Docker for production)
- Setting up connections to VPS-hosted services for development
- Setting up CI/CD pipelines optimized for Hetzner VPS deployment via Coolify

### Development Workflow
Since all services are VPS-hosted, the development workflow will be:
1. **Local Code Development**: Edit code locally
2. **VPS Service Connection**: Connect to PostgreSQL, Redis, RabbitMQ, MinIO on VPS
3. **Local Testing**: Run tests locally against VPS services
4. **Git Push**: Push to GitHub triggers Coolify deployment
5. **Production**: Applications deployed to VPS with same service connections

### Coolify Integration Notes
**Source: architecture/14-deployment-architecture.md**

Coolify deployment workflow:
1. **Git Push**: Developer pushes to GitHub
2. **Webhook**: Coolify receives webhook and starts build
3. **Nixpacks Build**: Applications built using Nixpacks configuration
4. **Deploy**: Deployed to Hetzner VPS with automatic SSL
5. **Monitor**: Coolify provides built-in monitoring and health checks

No separate Docker images are needed for production - Nixpacks handles the build process automatically.

### Testing

**Source: architecture/16-testing-strategy.md**

Testing standards that must be configured:
- **Framework**: Vitest for all unit and integration tests
- **Mobile E2E**: Maestro for React Native testing
- **Web E2E**: Playwright for web dashboards
- **Coverage Requirements**:
  - API Gateway: 80% unit, 60% integration
  - Agent Services: 70% unit, 50% integration
  - Shared Packages: 90% unit
- **Test Location**: `__tests__.ts` files next to source files
- **CI Integration**: Tests must run in GitHub Actions with coverage reporting
- **Test Database**: Separate PostgreSQL test database configured via DATABASE_TEST_URL
- **Coolify Testing**: Tests run before deployment; failed tests prevent deployment

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-15 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-01-15 | 1.1 | Updated for existing GitHub repo and Nixpacks deployment | Bob (Scrum Master) |
| 2025-01-15 | 1.2 | Updated to use VPS-hosted services for all environments | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_(To be populated by Dev Agent)_

### Debug Log References
_(To be populated by Dev Agent)_

### Completion Notes List
_(To be populated by Dev Agent)_

### File List
_(To be populated by Dev Agent)_

## QA Results
_(To be populated by QA Agent)_